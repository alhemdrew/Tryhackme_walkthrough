# ğŸ¦  TryHackMe â€“ Advent of Cyber 2025  
## Day 21: Malware Analysis â€“ *Malhare.exe*

---

## ğŸ–¼ï¸ Room Banner

![Malware Analysis â€“ Malhare.exe](https://tryhackme-images.s3.amazonaws.com/room-icons/aoc2025-day21.png)

---

## ğŸ“Œ Room Overview

**Room Name:** Malware Analysis â€“ Malhare.exe  
**Difficulty:** Beginner â†’ Intermediate  
**Duration:** ~60 minutes  
**Category:** Malware Analysis / Digital Forensics  
**File Type Analysed:** HTA (HTML Application)  
**Status:** âœ… Completed (100%)

This room introduces **static malware analysis** using a malicious **HTA file** disguised as a legitimate survey. The goal is to reverse-engineer the file, understand its behaviour, and uncover how **King Malhare** compromised Warevilleâ€™s systems.

---

## ğŸ¯ Learning Objectives

- Understand what **HTA (HTML Application)** files are
- Learn why HTAs are abused by malware authors
- Perform **static analysis** on a malicious file
- Identify **obfuscation techniques** (Base64, ROT13)
- Detect **data exfiltration mechanisms**
- Trace execution flow inside VBScript & PowerShell

---

## ğŸ“– Task 1 â€“ Introduction (Story)

Warevilleâ€™s systems process thousands of files daily â€” PDFs, DOCX files, spreadsheets, and executables. Among these, **HTA files** can look harmless but may hide malicious intent.

King Malhare exploited this by sending a **fake salary survey** to TBFC elves. Those who opened the HTA unknowingly executed malware.

Your task is to **analyze the HTA safely** and uncover what it really does.

âš ï¸ **Important:**  
Never execute malware locally. Analysis is done using **text editors only** inside the AttackBox.

---

## ğŸ§  Task 2 â€“ Understanding HTA Files

### ğŸ”¹ What is an HTA?
An **HTA (HTML Application)** is:
- Built using **HTML, CSS, and JavaScript/VBScript**
- Executed by **mshta.exe**
- Runs with **full user privileges**
- Not sandboxed like a browser

### ğŸ”¹ Legitimate Uses
- Admin automation
- Setup utilities
- Internal IT tools
- Lightweight desktop apps

### ğŸ”¹ Why Attackers Love HTAs
- Easy to disguise as documents or tools
- Can execute scripts immediately
- Can call PowerShell, CMD, or Windows utilities
- Often bypass security controls

---

## ğŸ§± HTA File Structure

An HTA file contains:

1. **HTA Declaration**
   - Defines window behaviour and metadata
2. **HTML Interface**
   - What the user sees
3. **Script Section (VBScript / JavaScript)**
   - The real logic and execution

---

## âš”ï¸ Malicious HTA Behaviour

Malicious HTAs commonly:
- Arrive via **phishing emails**
- Launch via **mshta.exe**
- Contain **encoded payloads**
- Download second-stage malware
- Use **living-off-the-land binaries**
  - PowerShell
  - WScript
  - rundll32

---

## ğŸ› ï¸ Environment Setup

### Tool Used
- **AttackBox**

### File Location
```bash
/root/Rooms/AoC2025/Day21/survey.hta
Safe Viewing Command
bash
Copy code
pluma /root/Rooms/AoC2025/Day21/survey.hta
ğŸ” Static Analysis Process
Step 1: Metadata Analysis
Inspect <head> section

Identify application title and purpose

Step 2: Script Analysis
Locate <script type="text/vbscript">

Identify functions and execution flow

Step 3: Look for Indicators
Encoded strings (Base64)

Network calls

PowerShell execution

Data exfiltration

ğŸ§  Identified VBScript Functions
The HTA contains 5 key functions:

window_onLoad

Automatically runs on execution

Calls getQuestions()

getQuestions

Downloads external data

Decodes Base64

Passes data for execution

provideFeedback

Collects system information

Sends data externally

Executes PowerShell

decodeBase64

Converts Base64 â†’ binary

RSBinaryToString

Converts binary â†’ string

ğŸ§ª Objects Used (Indicators of Malicious Activity)
InternetExplorer.Application â†’ external connections

WScript.Network â†’ system enumeration

WScript.Shell â†’ command execution

ğŸ“¤ Data Exfiltration Details
Exfiltrated Information
ComputerName

UserName

Endpoint Used
```
/details
```
HTTP Method
```
GET
```
ğŸ§¨ Code Execution Line
The downloaded payload is executed using:

vbscript
```
runObject.Run "powershell.exe -nop -w hidden -c " & feedbackString, 0, False
```
This confirms remote code execution via PowerShell.

ğŸ” Obfuscation Techniques Used
```
Base64 â€“ hides payload
```
ROT13 â€“ second-layer obfuscation
```
Both were decoded using CyberChef.

ğŸ Flag
```
THM{Malware.Analysed}
ğŸ›¡ï¸ Key Takeaways
HTA files can be extremely dangerous

Static analysis prevents accidental execution

Encoding â‰  encryption â€” always decode

Social engineering is embedded even in code

Malware often hides behind legitimate-looking content

ğŸ‰ Conclusion
This room demonstrates how attackers abuse trusted file formats to gain execution on systems. Understanding HTA internals, script behaviour, and obfuscation techniques is essential for malware analysts and SOC teams.

âš ï¸ Always analyze suspicious files offline and safely.

âœ… Room Completed â€“ 100%


                                  ## âœ… Advent of Cyber 2025 â€“ Day 21 Answers

1. **What is the title of the HTA application?**  
   **Answer:** Best Festival Company Developer Survey

2. **What VBScript function is acting as if it is downloading the survey questions?**  
   **Answer:** getQuestions

3. **What URL domain (including sub-domain) is the "questions" being downloaded from?**  
   **Answer:** survey.bestfestiivalcompany.com

4. **Malhare seems to be using typosquatting. What character in the domain gives this away?**  
   **Answer:** i

5. **How many questions does the survey have?**  
   **Answer:** 4

6. **The survey entices participation by promising a chance to win a trip to where?**  
   **Answer:** South Pole

7. **What two pieces of information about the computer are being exfiltrated?**  
   **Answer:** ComputerName,UserName

8. **What endpoint is the enumerated data being exfiltrated to?**  
   **Answer:** /details

9. **What HTTP method is being used to exfiltrate the data?**  
   **Answer:** GET

10. **What line of code executes the contents of the downloaded data?**  
    **Answer:**  
    runObject.Run "powershell.exe -nop -w hidden -c " & feedbackString, 0, False

11. **What popular encoding scheme was used to obfuscate the download?**  
    **Answer:** base64

12. **What common encryption scheme was used in the script after decoding?**  
    **Answer:** rot13

13. **What is the final flag value?**  
    **Answer:** THM{Malware.Analysed}
